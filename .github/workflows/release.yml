name: Build and Release Extensions

on:
  push:
    tags:
      - 'v*' # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch: # æ·»åŠ æ‰‹åŠ¨è§¦å‘é€‰é¡¹
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'
      release:
        description: 'æ˜¯å¦å‘å¸ƒåˆ°å•†åº—'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          sudo apt-get update
          sudo apt-get install -y jq
          
      - name: Install web-ext
        run: |
          echo "Installing web-ext globally..."
          sudo npm install --global web-ext

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          # ç§»é™¤ç‰ˆæœ¬å·å‰ç¼€ 'v'
          CLEAN_VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "CLEAN_VERSION=$CLEAN_VERSION" >> $GITHUB_OUTPUT

      - name: Update manifest version
        run: |
          echo "Updating manifest version to ${{ steps.get_version.outputs.CLEAN_VERSION }}..."
          # é¦–å…ˆå°è¯•ä½¿ç”¨jqæ›´æ–°manifest.jsonä¸­çš„ç‰ˆæœ¬å·
          if command -v jq &> /dev/null; then
            jq ".version=\"${{ steps.get_version.outputs.CLEAN_VERSION }}\"" manifest.json > manifest.json.tmp
            if [ $? -eq 0 ]; then
              mv manifest.json.tmp manifest.json
            else
              echo "jqå¤„ç†å¤±è´¥ï¼Œä½¿ç”¨sedä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ"
              sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"${{ steps.get_version.outputs.CLEAN_VERSION }}\"/" manifest.json
            fi
          else
            echo "æœªæ‰¾åˆ°jqï¼Œä½¿ç”¨sedæ›´æ–°ç‰ˆæœ¬å·"
            sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"${{ steps.get_version.outputs.CLEAN_VERSION }}\"/" manifest.json
          fi
          
          # éªŒè¯ç‰ˆæœ¬æ˜¯å¦å·²æ›´æ–°
          echo "Updated manifest.json:"
          grep "\"version\"" manifest.json

      - name: Prepare Firefox manifest
        run: |
          echo "Creating Firefox manifest..."
          cp manifest.json manifest.firefox.json
          sed -i 's/"manifest_version": 3/"manifest_version": 2/' manifest.firefox.json
          sed -i 's/"action"/"browser_action"/' manifest.firefox.json
          sed -i 's/"service_worker"/"scripts"/' manifest.firefox.json
          sed -i 's/"host_permissions"/"permissions"/' manifest.firefox.json
          sed -i 's/"_execute_action"/"_execute_browser_action"/' manifest.firefox.json
          # Add Firefox specific settings
          sed -i '/"name"/ a\    "browser_specific_settings": {\n      "gecko": {\n        "id": "github-data-push@extensions",\n        "strict_min_version": "57.0"\n      }\n    },' manifest.firefox.json

      - name: Build Chrome extension
        run: |
          echo "Building Chrome extension..."
          mkdir -p dist/chrome
          cp -r popup.* i18n.js icons styles.css background.js manifest.json dist/chrome/
          cd dist/chrome
          zip -r ../chrome-github-data-push-${{ steps.get_version.outputs.VERSION }}.zip .

      - name: Build Firefox extension
        run: |
          echo "Building Firefox extension..."
          mkdir -p dist/firefox
          cp -r popup.* i18n.js icons styles.css background.js manifest.firefox.json dist/firefox/
          mv dist/firefox/manifest.firefox.json dist/firefox/manifest.json
          cd dist/firefox
          echo "Current directory contents:"
          ls -la
          echo "Building web-ext..."
          web-ext build --artifacts-dir ../ --overwrite-dest
          cd ..
          echo "Dist directory contents:"
          ls -la
          # Find and rename the Firefox extension zip file (handle both hyphen and underscore patterns)
          FIREFOX_ZIP=$(find . -name "github[-_]data[-_]push-*.zip" ! -name "*-chrome.zip")
          if [ -n "$FIREFOX_ZIP" ]; then
            echo "Found Firefox extension: $FIREFOX_ZIP"
            mv "$FIREFOX_ZIP" "firefox-github-data-push-${{ steps.get_version.outputs.VERSION }}.xpi"
            echo "After renaming:"
            ls -la
          else
            echo "Error: No Firefox extension zip file found!"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: ${{ github.event_name != 'workflow_dispatch' || (github.event_name == 'workflow_dispatch' && !github.event.inputs.release) }}
        with:
          files: |
            dist/chrome-github-data-push-${{ steps.get_version.outputs.VERSION }}.zip
            dist/firefox-github-data-push-${{ steps.get_version.outputs.VERSION }}.xpi
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## GitHub Data Push ${{ steps.get_version.outputs.VERSION }}
            
            ### ğŸŒ æ”¯æŒçš„æµè§ˆå™¨ / Supported Browsers
            - Chrome/Edge (Manifest V3)
            - Firefox (Manifest V2)
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜ / Download Instructions
            
            #### Chrome/Edge:
            1. ä¸‹è½½ `chrome-github-data-push-[ç‰ˆæœ¬å·].zip`
            2. è®¿é—® `chrome://extensions`
            3. å¼€å¯"å¼€å‘è€…æ¨¡å¼"
            4. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
            5. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
            
            #### Firefox:
            1. ä¸‹è½½ `firefox-github-data-push-[ç‰ˆæœ¬å·].xpi`
            2. è®¿é—® `about:addons`
            3. ç‚¹å‡»é½¿è½®å›¾æ ‡ï¼Œé€‰æ‹©"ä»æ–‡ä»¶å®‰è£…é™„åŠ ç»„ä»¶"
            4. é€‰æ‹©ä¸‹è½½çš„ `.xpi` æ–‡ä»¶
            
            ### ğŸŒ æ”¯æŒçš„è¯­è¨€ / Supported Languages
            - ç®€ä½“ä¸­æ–‡ (Chinese Simplified)
            - English
            - æ—¥æœ¬èª (Japanese)
            - í•œêµ­ì–´ (Korean)
            - FranÃ§ais (French)
            - Deutsch (German)
            - EspaÃ±ol (Spanish)
            
            ### ğŸ“ åŠŸèƒ½ç‰¹ç‚¹ / Features
            - âœ¨ è‡ªå®šä¹‰æ•°æ®æ¨¡æ¿
            - ğŸ”„ å¤šè¯­è¨€æ”¯æŒ
            - ğŸ”’ å®‰å…¨çš„ Token ç®¡ç†
            - ğŸ“ çµæ´»çš„æ•°æ®å­˜å‚¨
            - ğŸ¨ ç›´è§‚çš„ç”¨æˆ·ç•Œé¢
            
            ### ğŸ’¡ ä½¿ç”¨æç¤º / Usage Tips
            1. é¦–æ¬¡ä½¿ç”¨è¯·åœ¨è®¾ç½®ä¸­é…ç½® GitHub Token
            2. é€‰æ‹©æˆ–åˆ›å»ºæ•°æ®æ¨¡æ¿
            3. é€‰æ‹©ç›®æ ‡ä»“åº“
            4. å¡«å†™å¹¶æäº¤æ•°æ®
            
            ### ğŸ” éšç§è¯´æ˜ / Privacy Notice
            - Token ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­
            - æ‰€æœ‰æ•°æ®ä¼ è¾“å‡ä½¿ç”¨ GitHub API åŠ å¯†é€šé“

      # å•†åº—å‘å¸ƒä»»åŠ¡ (ä»…åœ¨æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©å‘å¸ƒæ—¶æ‰§è¡Œ)
      - name: Upload to Chrome Web Store
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'true' }}
        uses: mnao305/chrome-extension-upload@v4.0.1
        with:
          file-path: dist/chrome-github-data-push-${{ steps.get_version.outputs.VERSION }}.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          
      - name: Upload to Firefox Add-ons
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'true' }}
        uses: trmcnvn/firefox-addon@v1
        with:
          uuid: ${{ secrets.FIREFOX_ADDON_ID }}
          xpi: dist/firefox-github-data-push-${{ steps.get_version.outputs.VERSION }}.xpi
          manifest: dist/firefox/manifest.json
          api-key: ${{ secrets.FIREFOX_API_KEY }}
          api-secret: ${{ secrets.FIREFOX_API_SECRET }} 